<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/blockforge.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockForge Vertical Sign Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/STLExporter.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;600;800&display=swap" rel="stylesheet">
    <style>
        /* Redundant #image-preview from copy-paste, can be removed */
        #image-preview {
            width: 100%;
            height: 180px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
            border: 2px solid #eee;
            background: #f8f8f8;
        }
        :root { --navy: #0D2B3E; --steel: #1A4D6D; --orange: #FF5722; --white: #FFFFFF; }
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Work Sans', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            color: var(--navy); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* Top Control Panel */
        .controls-container { 
            width: 100%; 
            background: white; 
            padding: 1.5rem 2rem; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            z-index: 101; /* Ensure it's above the nav bar */
            display: grid;
            grid-template-columns: 1fr 1fr 0.8fr; 
            gap: 3rem;
            align-items: start;
        }

        .col { display: flex; flex-direction: column; gap: 1rem; }
        
        .logo { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--navy); cursor: pointer; margin-bottom: 0.5rem; } /* This is now handled by partials */
        .logo span { color: var(--orange); }
        .badge { font-size: 0.7rem; font-weight: 700; background: #eee; padding: 4px 8px; border-radius: 4px; vertical-align: middle; margin-left: 10px; }
        
        label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 0.5rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 1.5rem; text-transform: uppercase; }
        input[type="text"]:focus { border-color: var(--orange); outline: none; }
        
        .color-picker { display: flex; gap: 8px; flex-wrap: wrap; }
        .color-opt { width: 32px; height: 32px; border-radius: 6px; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .color-opt.active { border-color: var(--navy); transform: scale(1.15); }

        .workspace { flex: 1; width: 100%; position: relative; background: #e0e0e0; overflow: hidden; }
        #canvas-container { width: 100%; height: 100%; }
        
        .stats { background: var(--navy); color: white; padding: 15px; border-radius: 10px; font-family: 'Space Mono', monospace; font-size: 0.8rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px;}
        
        @media (max-width: 900px) {
            .controls-container { grid-template-columns: 1fr; gap: 1.5rem; height: auto; }
            .workspace { height: 500px; }
        }
    </style>
    <script src="assets/partials/partials-loader.js"></script>
</head>
<body>
    <div data-partial="nav" data-tool-title="Vertical Sign Tool"></div>
    <div class="controls-container">
        <div class="col">
            <div>
                <span class="logo" onclick="location.href='index.html'">BLOCK<span>FORGE</span></span>
                <span class="badge">VERTICAL SIGN</span>
            </div>
            <div>
                <label>1. Enter Name</label>
                <input type="text" id="text-input" placeholder="NAME" value="CEO" maxlength="10" oninput="generate()">
            </div>
            <div class="stats" id="stats-panel"></div>
        </div>

        <div class="col">
            <div>
                <label>2. Text Color</label>
                <div class="color-picker" id="text-color-picker"></div>
            </div>
            <div>
                <label>Background Wall</label>
                <div class="color-picker" id="bg-color-picker"></div>
            </div>
        </div>

        <div class="col" style="justify-content: space-between; height: 100%;">
            <div>
                <label>3. Height</label>
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; font-weight:600; margin-bottom:5px;">
                    <span>Size</span>
                    <span id="height-val" style="color:var(--orange)">3 Bricks</span>
                </div>
                <input type="range" id="height-slider" min="2" max="6" value="3" style="width:100%" oninput="generate()" title="Select sign height in bricks">
            </div>

            <div class="controls">
                <button class="btn btn-outline" onclick="generateInstructions()">ðŸ“„ Guide</button>
                <button class="btn btn-primary" onclick="exportSTL()">ðŸ’¾ STL</button>
            </div>
        </div>
    </div>

    <div class="workspace">
        <div id="canvas-container"></div>
    </div>

<script>
    // --- Config ---
    const colors = [
        { name: 'Red', hex: '#C91A09' }, { name: 'Blue', hex: '#0055BF' },
        { name: 'Yellow', hex: '#F2CD37' }, { name: 'Black', hex: '#1B2A34' },
        { name: 'White', hex: '#FFFFFF' }, { name: 'Grey', hex: '#A0A5A9' },
        { name: 'Green', hex: '#237841' }, { name: 'Orange', hex: '#DA8540' }
    ];

    const font = {
        'A': [[0,1,1,1,0],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],
        'B': [[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],
        'C': [[0,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,1]],
        'D': [[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],
        'E': [[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,0],[1,1,1,1,1]],
        'F': [[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0]],
        'G': [[0,1,1,1,1],[1,0,0,0,0],[1,0,1,1,1],[1,0,0,0,1],[0,1,1,1,1]],
        'H': [[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],
        'I': [[1,1,1],[0,1,0],[0,1,0],[0,1,0],[1,1,1]],
        'J': [[0,0,0,0,1],[0,0,0,0,1],[0,0,0,0,1],[1,0,0,0,1],[0,1,1,1,0]],
        'K': [[1,0,0,0,1],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,0,1]],
        'L': [[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],
        'M': [[1,0,0,0,1],[1,1,0,1,1],[1,0,1,0,1],[1,0,0,0,1],[1,0,0,0,1]],
        'N': [[1,0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],
        'O': [[0,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[0,1,1,1,0]],
        'P': [[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0]],
        'Q': [[0,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,1,0],[0,1,1,0,1]],
        'R': [[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],
        'S': [[0,1,1,1,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],
        'T': [[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],
        'U': [[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[0,1,1,1,0]],
        'V': [[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0]],
        'W': [[1,0,0,0,1],[1,0,0,0,1],[1,0,1,0,1],[1,1,0,1,1],[1,0,0,0,1]],
        'X': [[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],
        'Y': [[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],
        'Z': [[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],
        ' ': [[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]]
    };

    let scene, camera, renderer, textGroup;
    let textColor = colors[3], bgColor = colors[4];
    let gridData = [];

    function init() {
        const container = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe0e0e0);

        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 15, 35);
        camera.lookAt(0, 5, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(10, 20, 20);
        dir.castShadow = true;
        scene.add(dir);

        buildColorPicker('text-color-picker', (c) => { textColor = c; generate(); }, 'Black');
        buildColorPicker('bg-color-picker', (c) => { bgColor = c; generate(); }, 'White');

        generate();
        animate();
    }

    function buildColorPicker(id, callback, defaultName) {
        const container = document.getElementById(id);
        colors.forEach(c => {
            let btn = document.createElement('div');
            btn.className = 'color-opt';
            btn.style.backgroundColor = c.hex;
            btn.onclick = () => { 
                Array.from(container.children).forEach(x => x.classList.remove('active'));
                btn.classList.add('active');
                callback(c); 
            };
            if(c.name === defaultName) btn.classList.add('active');
            container.appendChild(btn);
        });
    }

    function generate() {
        const text = document.getElementById('text-input').value.toUpperCase() || " ";
        const height = parseInt(document.getElementById('height-slider').value);
        document.getElementById('height-val').textContent = height + " Bricks";

        if(textGroup) scene.remove(textGroup);
        textGroup = new THREE.Group();

        // 1. Build 2D Grid
        let grid = [];
        let rows = 5;
        for(let i=0; i<rows; i++) grid[i] = [];
        for (let char of text) {
            let map = font[char] || font[' '];
            if(!map) map = font[' '];
            for(let r=0; r<rows; r++) { grid[r] = grid[r].concat(map[r]); grid[r].push(0); }
        }
        for(let r=0; r<rows; r++) grid[r].pop();

        const padding = 2;
        const totalW = grid[0].length + (padding*2);
        gridData = { grid, totalW, height, padding }; // Save for instructions

        // 2. Build 3D
        const brickGeo = new THREE.BoxGeometry(1, 1.2, 1);
        const studGeo = new THREE.CylinderGeometry(0.25, 0.25, 0.2, 16);
        let tCount = 0, bCount = 0;

        // Base
        for(let x=0; x<totalW; x++) {
            addBrick(x - totalW/2, 0, '#444');
        }

        // Wall
        for(let r=0; r<rows; r++) {
            const fontRow = (rows - 1) - r; // Flip for build up
            const rowData = grid[fontRow];
            let xPos = 0;
            // Left Pad
            for(let p=0; p<padding; p++) { addBrick(xPos - totalW/2, r+1, bgColor.hex); xPos++; bCount++; }
            // Text
            for(let x=0; x<rowData.length; x++) {
                const isText = rowData[x] === 1;
                // If height > 1, maybe extrude text? For now, flat wall for stability.
                addBrick(xPos - totalW/2, r+1, isText ? textColor.hex : bgColor.hex);
                xPos++;
                if(isText) tCount++; else bCount++;
            }
            // Right Pad
            for(let p=0; p<padding; p++) { addBrick(xPos - totalW/2, r+1, bgColor.hex); xPos++; bCount++; }
        }
        
        // Cap
        for(let x=0; x<totalW; x++) {
            addBrick(x - totalW/2, rows+1, bgColor.hex);
            bCount++;
        }

        function addBrick(x, y, color) {
            const mat = new THREE.MeshStandardMaterial({ color: color });
            const mesh = new THREE.Mesh(brickGeo, mat);
            mesh.position.set(x, y * 1.2, 0);
            
            const stud = new THREE.Mesh(studGeo, mat);
            stud.position.set(0, 0.6 + 0.1, 0);
            mesh.add(stud);
            
            mesh.castShadow = true; mesh.receiveShadow = true;
            textGroup.add(mesh);
        }

        scene.add(textGroup);
        
        // Stats
        document.getElementById('stats-panel').innerHTML = `
            <div class="stat-row"><span>Width:</span> <span>${totalW} studs</span></div>
            <div class="stat-row"><span>Height:</span> <span>${rows+2} bricks</span></div>
            <div class="stat-row"><span>${textColor.name}:</span> <span>${tCount}</span></div>
            <div class="stat-row"><span>${bgColor.name}:</span> <span>${bCount}</span></div>
            <div class="stat-total">Total Parts: ${tCount + bCount + totalW}</div>
        `;

        camera.position.set(0, 10, Math.max(25, totalW));
    }

    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

    function exportSTL() {
        const exporter = new THREE.STLExporter();
        const str = exporter.parse(textGroup);
        const blob = new Blob([str], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Sign_${document.getElementById('text-input').value}.stl`;
        link.click();
    }

    function generateInstructions() {
        // Generate a visual guide using canvas
        const win = window.open('', '_blank');
        const d = gridData;
        
        let layersHTML = '';
        
        // Helper to draw a row to base64
        function drawRow(rowIndex, rowData) {
            const cv = document.createElement('canvas');
            const studS = 20;
            cv.width = d.totalW * studS; cv.height = studS;
            const ctx = cv.getContext('2d');
            
            let xPos = 0;
            // Pad
            ctx.fillStyle = bgColor.hex;
            for(let p=0; p<d.padding; p++) { ctx.fillRect(xPos*studS, 0, studS, studS); ctx.strokeRect(xPos*studS, 0, studS, studS); xPos++; }
            
            // Text
            for(let i=0; i<rowData.length; i++) {
                ctx.fillStyle = rowData[i] === 1 ? textColor.hex : bgColor.hex;
                ctx.fillRect(xPos*studS, 0, studS, studS);
                ctx.strokeRect(xPos*studS, 0, studS, studS);
                xPos++;
            }
            
            // Pad
            ctx.fillStyle = bgColor.hex;
            for(let p=0; p<d.padding; p++) { ctx.fillRect(xPos*studS, 0, studS, studS); ctx.strokeRect(xPos*studS, 0, studS, studS); xPos++; }
            
            return cv.toDataURL();
        }

        // Build HTML for layers (Bottom Up)
        const rows = 5;
        for(let r=0; r<rows; r++) {
            const fontRow = (rows - 1) - r;
            const img = drawRow(r, d.grid[fontRow]);
            layersHTML += `
                <div style="margin-bottom:20px; border:1px solid #ccc; padding:10px; break-inside: avoid;">
                    <h3>Layer ${r+2}</h3>
                    <img src="${img}" style="width:100%; image-rendering: pixelated; border:1px solid #333;">
                </div>
            `;
        }

        win.document.write(`
            <html>
            <head><title>Sign Build Guide</title><style>body{font-family:sans-serif; max-width:800px; margin:0 auto; padding:20px;} h1{text-align:center; color:#333;}</style></head>
            <body>            
                <h1>Build Guide: ${document.getElementById('text-input').value.toUpperCase()}</h1>
                <div style="background:#eee; padding:15px; border-radius:8px; margin-bottom:30px;">
                    <strong>Parts List:</strong><br>
                    ${document.getElementById('stats-panel').innerHTML}
                </div>
                <h2>Assembly (Bottom to Top)</h2>
                <p><strong>Layer 1 (Base):</strong> ${d.totalW}x Dark Grey</p>
                ${layersHTML}
                <p><strong>Layer ${rows+2} (Cap):</strong> ${d.totalW}x ${bgColor.name}</p>
                <div style="text-align:center; margin-top:50px; color:#888;">Generated by BlockForgeStudio.com</div>
            </body>
            </html>
        `);
        win.document.close();
        setTimeout(() => win.print(), 500);
    }

    window.addEventListener('resize', () => {
        camera.aspect = document.getElementById('canvas-container').clientWidth / document.getElementById('canvas-container').clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(document.getElementById('canvas-container').clientWidth, document.getElementById('canvas-container').clientHeight);
    });

    init();
</script>
</body>
</html>