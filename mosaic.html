<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mosaic Studio - BlockForge | Build. Paint. Create.</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Light Theme (Default) */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #e9ecef;
      --text-primary: #212529;
      --text-secondary: #495057;
      --text-muted: #6c757d;
      --text-inverted: #ffffff;
      --accent-primary: #FF5722;
      --accent-secondary: #1A4D6D;
      --border-primary: #dee2e6;
      --shadow-primary: rgba(0, 0, 0, 0.1);
      --shadow-secondary: rgba(0, 0, 0, 0.15);
    }

    .dark-mode {
      /* Dark Theme */
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-muted: #999999;
      --text-inverted: #121212;
      --accent-primary: #FF7043;
      --accent-secondary: #4FC3F7;
      --border-primary: #444444;
      --shadow-primary: rgba(0, 0, 0, 0.3);
      --shadow-secondary: rgba(0, 0, 0, 0.5);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Work Sans', sans-serif; 
      background: var(--bg-primary); 
      color: var(--text-primary);
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }

    /* Navigation */
    .nav-hub {
      background: var(--bg-secondary);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px var(--shadow-primary);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 2px solid var(--accent-primary);
    }

    .nav-hub-title {
      font-family: 'Space Mono', monospace;
      font-weight: bold;
      font-size: 1.3rem;
      color: var(--text-primary);
      -webkit-user-select: none;
      user-select: none;
      cursor: pointer;
    }

    .nav-hub-title span {
      color: var(--accent-primary);
    }

    .theme-toggle-btn {
      background: transparent;
      border: 2px solid var(--accent-primary);
      color: var(--text-primary);
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 1.2rem;
      transition: all 0.3s;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle-btn:hover {
      background: var(--accent-primary);
      transform: scale(1.1);
    }

    .nav-hub-btn {
      background: transparent;
      border: 2px solid var(--accent-primary);
      color: var(--accent-primary);
      padding: 8px 20px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s;
      min-height: 44px;
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    .nav-hub-btn:hover {
      background: var(--accent-primary);
      color: var(--text-inverted);
      transform: translateY(-2px);
    }

    /* Page Header */
    .page-header {
      background: linear-gradient(135deg, var(--accent-primary) 0%, #FF7043 100%);
      padding: 4rem 2rem 3rem;
      text-align: center;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    }

    .page-header-content {
      position: relative;
      z-index: 1;
      max-width: 900px;
      margin: 0 auto;
    }

    .page-header h1 {
      font-size: clamp(2.5rem, 5vw, 3.5rem);
      font-weight: 800;
      margin-bottom: 1rem;
      letter-spacing: -1px;
    }

    .page-header .tagline {
      font-size: clamp(1.2rem, 2vw, 1.5rem);
      font-family: 'Space Mono', monospace;
      margin-bottom: 1rem;
      opacity: 0.9;
    }

    .page-header .subtitle {
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto 1.5rem;
      line-height: 1.6;
      opacity: 0.85;
    }

    /* Main Container */
    .main-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .workspace {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }

    @media (max-width: 968px) {
      .workspace {
        grid-template-columns: 1fr;
      }
    }

    /* Panels */
    .panel {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px var(--shadow-primary);
      border: 1px solid var(--border-primary);
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInScale 0.6s ease forwards;
    }

    .panel:nth-child(1) { animation-delay: 0.1s; }
    .panel:nth-child(2) { animation-delay: 0.2s; }
    .panel:nth-child(3) { animation-delay: 0.3s; }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .panel h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel h2::before {
      content: '';
      width: 4px;
      height: 24px;
      background: var(--accent-primary);
      border-radius: 2px;
    }

    /* Form Elements */
    label {
      display: block;
      margin: 1.5rem 0 0.5rem;
      color: var(--text-muted);
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    label:first-of-type {
      margin-top: 0;
    }

    input[type="file"] {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border: 2px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'Work Sans', sans-serif;
      margin-top: 0.5rem;
      cursor: pointer;
    }

    input[type="file"]:hover {
      border-color: var(--accent-primary);
    }

    input[type="file"]::file-selector-button {
      background: var(--accent-primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      margin-right: 1rem;
      cursor: pointer;
      font-family: 'Work Sans', sans-serif;
      font-weight: 600;
      transition: all 0.3s;
    }

    input[type="file"]::file-selector-button:hover {
      background: #FF7043;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      cursor: pointer;
      background: var(--bg-tertiary);
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(255, 87, 34, 0.4);
      transition: all 0.3s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(255, 87, 34, 0.4);
    }

    input[type="text"] {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      color: var(--text-primary);
      padding: 0.75rem;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      font-family: 'Space Mono', monospace;
      transition: all 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.1);
    }

    .range-value {
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-align: right;
      margin-top: 0.25rem;
      font-family: 'Space Mono', monospace;
      font-weight: 600;
    }

    /* Checkbox Row */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 1rem 0;
      background: var(--bg-tertiary);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      transition: all 0.3s;
      cursor: pointer;
    }

    .checkbox-row:hover {
      background: var(--bg-secondary);
      transform: translateY(-1px);
    }

    .checkbox-row input {
      margin: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-primary);
    }

    .checkbox-row label {
      margin: 0;
      text-transform: none;
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      flex: 1;
    }

    .checkbox-row label strong {
      color: var(--text-primary);
      display: block;
      margin-bottom: 0.25rem;
    }

    .checkbox-row label span {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    /* Boost Section */
    .boost-section {
      background: var(--bg-tertiary);
      padding: 1.25rem;
      border-radius: 8px;
      margin-top: 1.5rem;
      border: 1px solid var(--border-primary);
    }

    .boost-section h3 {
      font-size: 0.95rem;
      color: var(--text-primary);
      margin: 0 0 1rem;
      font-weight: 600;
    }

    /* Buttons */
    .controls {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .btn {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Work Sans', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary) 0%, #FF7043 100%);
      color: white;
      box-shadow: 0 6px 20px rgba(255, 87, 34, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(255, 87, 34, 0.5);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-primary);
    }

    .btn-secondary:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    /* Actions Section */
    .actions-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-primary);
    }

    /* Preview Canvas */
    .preview-wrap {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    #render {
      width: 100%;
      height: auto;
      border-radius: 12px;
      background: var(--bg-tertiary);
      box-shadow: 0 4px 20px var(--shadow-primary);
      display: block;
      border: 1px solid var(--border-primary);
    }

    /* Stats */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-box {
      background: linear-gradient(135deg, var(--accent-primary) 0%, #FF7043 100%);
      padding: 1.25rem;
      border-radius: 12px;
      text-align: center;
      color: white;
      transition: all 0.3s;
    }

    .stat-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 87, 34, 0.4);
    }

    .stat-val {
      font-size: 2rem;
      font-weight: 800;
      font-family: 'Space Mono', monospace;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-top: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* BOM Table */
    .bom-scroll {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      background: var(--bg-tertiary);
    }

    .bom-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .bom-scroll::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .bom-scroll::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      text-align: left;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      position: sticky;
      top: 0;
      padding: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
      z-index: 1;
      border-bottom: 2px solid var(--accent-primary);
    }

    td {
      border-bottom: 1px solid var(--border-primary);
      padding: 0.75rem 0.875rem;
      color: var(--text-secondary);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: var(--bg-secondary);
    }

    .color-dot {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 0.75rem;
      border: 2px solid var(--border-primary);
      vertical-align: middle;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Info Section */
    .info-section {
      margin-top: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
      border-radius: 12px;
      border: 2px solid var(--accent-primary);
    }

    .info-section h3 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .info-section p {
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 1rem;
    }

    code {
      background: var(--bg-primary);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Space Mono', monospace;
      font-size: 0.875rem;
      color: var(--accent-primary);
      border: 1px solid var(--border-primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-row {
        grid-template-columns: 1fr;
      }
      
      .page-header {
        padding: 3rem 1rem 2rem;
      }
      
      .main-container {
        padding: 0 1rem;
      }
      
      .panel {
        padding: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div class="nav-hub">
    <button id="theme-toggle" class="theme-toggle-btn" title="Toggle theme" aria-label="Toggle theme">üåô</button>
    <div class="nav-hub-title" onclick="location.href='index.html'">BLOCK<span>FORGE</span></div>
    <a href="index.html" class="nav-hub-btn">‚Üê Home</a>
  </div>

  <!-- Page Header -->
  <section class="page-header">
    <div class="page-header-content">
      <h1>Mosaic Studio</h1>
      <p class="tagline">Transform photos into stunning brick mosaics</p>
      <p class="subtitle">Convert any image into a buildable LEGO-compatible mosaic with vivid color matching and intelligent brick packing.</p>
    </div>
  </section>

  <!-- Main Container -->
  <div class="main-container">
    <div class="workspace">
      <!-- Configuration Panel -->
      <div class="panel">
        <h2>Configuration</h2>
        
        <label>Source Image</label>
        <input id="file" type="file" accept="image/*" title="Select source image file">
        
        <label>Mosaic Width</label>
        <input id="width" type="range" min="16" max="256" value="80" title="Mosaic Width">
        <div class="range-value"><span id="width-val">80</span> studs</div>

        <label>Target Palette Size</label>
        <input id="colors" type="range" min="2" max="48" value="24" title="Target Palette Size">
        <div class="range-value"><span id="colors-val">24</span> colors</div>

        <div class="boost-section">
          <h3>Color Booster (Pre-process)</h3>
          
          <label>Saturation Boost</label>
          <input id="saturation" type="range" min="0" max="100" value="40" title="Saturation Boost">
          
          <label>Contrast Boost</label>
          <input id="contrast" type="range" min="0" max="100" value="20" title="Contrast Boost">
        </div>

        <div class="checkbox-row">
          <input id="hslMatch" type="checkbox" checked>
          <label for="hslMatch">
            <strong>Use Vivid Matching (HSL)</strong>
            <span>Prioritizes vivid bricks over dull ones for more vibrant results</span>
          </label>
        </div>

        <div class="checkbox-row">
          <input id="avoidSeams" type="checkbox" checked>
          <label for="avoidSeams">
            <strong>Structure (Brick bond pattern)</strong>
            <span>Creates staggered seams like real brick walls for better structural integrity</span>
          </label>
        </div>

        <label>Allowed Brick Sizes</label>
        <input id="bricksizes" type="text" value="4, 3, 2, 1" title="Allowed Brick Sizes (comma separated)" placeholder="e.g. 4, 3, 2, 1">
        
        <div class="controls">
          <button id="generate" class="btn btn-primary">üî® Generate Mosaic</button>
        </div>
        
        <div class="actions-section">
          <h2>Export Options</h2>
          <div class="controls">
            <button id="downloadPNG" class="btn btn-secondary">üì∏ Save PNG</button>
            <button id="downloadCSV" class="btn btn-secondary">üìÑ Export CSV</button>
          </div>
        </div>
      </div>

      <!-- Preview & BOM -->
      <div class="preview-wrap">
        <div class="panel">
          <h2>Visual Preview</h2>
          <canvas id="render"></canvas>
        </div>

        <div class="panel" id="bom-card" style="display:none">
          <h2>Parts List</h2>
          <div class="stats-row">
            <div class="stat-box">
              <div class="stat-val" id="total-bricks">0</div>
              <div class="stat-label">Total Bricks</div>
            </div>
            <div class="stat-box">
              <div class="stat-val" id="total-colors">0</div>
              <div class="stat-label">Unique Colors</div>
            </div>
            <div class="stat-box">
              <div class="stat-val" id="est-cost">$0</div>
              <div class="stat-label">Est. Cost</div>
            </div>
          </div>
          <div class="bom-scroll">
            <table id="bom-table">
              <thead><tr><th>Color</th><th>Size</th><th>Quantity</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Info Section -->
    <div class="info-section">
      <h3>About Mosaic Studio</h3>
      <p>This tool converts any image into a LEGO-compatible mosaic by:</p>
      <ul style="margin-left: 1.5rem; margin-bottom: 1rem; color: var(--text-muted);">
        <li>Analyzing and reducing colors to match available LEGO bricks</li>
        <li>Applying intelligent brick packing with sizes like <code>1√ó1</code>, <code>1√ó2</code>, <code>1√ó3</code>, <code>1√ó4</code></li>
        <li>Creating staggered seams for structural integrity (when enabled)</li>
        <li>Providing export options for building instructions</li>
      </ul>
      <p>Perfect for creating custom wall art, portraits, and decorative pieces from your favorite photos.</p>
    </div>
  </div>

<script>
/* ---------- Theme Switching ---------- */
const applyTheme = (theme) => {
  if (theme === 'dark') {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').innerHTML = '‚òÄÔ∏è';
    document.getElementById('theme-toggle').setAttribute('aria-label', 'Switch to light theme');
  } else {
    document.body.classList.remove('dark-mode');
    document.getElementById('theme-toggle').innerHTML = 'üåô';
    document.getElementById('theme-toggle').setAttribute('aria-label', 'Switch to dark theme');
  }
};

const savedTheme = localStorage.getItem('theme') || 'light';
applyTheme(savedTheme);

document.getElementById('theme-toggle').addEventListener('click', () => {
  const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
  localStorage.setItem('theme', newTheme);
  applyTheme(newTheme);
});

// --- EXPANDED "VIVID" PALETTE ---
const LEGO_PALETTE = [
  // Mono
  {name:"Black", hex:"#000000"},
  {name:"White", hex:"#FFFFFF"},
  {name:"Light Bluish Gray", hex:"#A0A5A9"},
  {name:"Dark Bluish Gray", hex:"#6C6E68"},
  // Reds/Pinks
  {name:"Red", hex:"#FF0000"},
  {name:"Dark Red", hex:"#720E0F"},
  {name:"Coral", hex:"#FF5544"},
  {name:"Magenta", hex:"#E3008C"},
  {name:"Dark Pink", hex:"#C870A0"},
  {name:"Bright Pink", hex:"#FFBBFF"},
  // Oranges/Yellows
  {name:"Orange", hex:"#FF7700"},
  {name:"Yellow", hex:"#FFD700"},
  {name:"Bright Light Orange", hex:"#FFBB00"},
  {name:"Dark Orange", hex:"#A95500"},
  {name:"Neon Orange", hex:"#FF3300"},
  // Greens
  {name:"Lime", hex:"#BBE90B"},
  {name:"Bright Green", hex:"#10CB31"},
  {name:"Green", hex:"#008F32"},
  {name:"Dark Green", hex:"#184632"},
  {name:"Olive Green", hex:"#9B9A5A"},
  {name:"Sand Green", hex:"#A0BCAC"},
  {name:"Yellowish Green", hex:"#DFEEA5"},
  // Blues/Azures
  {name:"Blue", hex:"#0055BF"},
  {name:"Dark Blue", hex:"#0A3463"},
  {name:"Medium Azure", hex:"#36AEBF"},
  {name:"Dark Azure", hex:"#078BC9"},
  {name:"Maersk Blue", hex:"#3592C3"},
  {name:"Sand Blue", hex:"#6074A1"},
  {name:"Dark Turquoise", hex:"#008F9B"},
  // Purples
  {name:"Medium Lavender", hex:"#AC78BA"},
  {name:"Lavender", hex:"#E1D5ED"},
  {name:"Purple", hex:"#81007B"},
  // Earth
  {name:"Reddish Brown", hex:"#582A12"},
  {name:"Dark Brown", hex:"#352100"},
  {name:"Tan", hex:"#E4CD9E"},
  {name:"Dark Tan", hex:"#958A73"},
  {name:"Medium Nougat", hex:"#CC702A"}
];

// --- APP STATE ---
const el = id => document.getElementById(id);
let imgBitmap = null;
let lastResult = null;

// --- LISTENERS ---
['width','colors'].forEach(id => {
  el(id).addEventListener('input', e => el(id+'-val').textContent = e.target.value);
});

// Initialize range values
el('width-val').textContent = el('width').value;
el('colors-val').textContent = el('colors').value;

el('file').addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = () => { 
    imgBitmap = img; 
    URL.revokeObjectURL(url);
    // Show preview
    const canvas = el('render');
    const ctx = canvas.getContext('2d');
    canvas.width = 400;
    canvas.height = 400 * (img.height / img.width);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  };
  img.src = url;
});

// --- COLOR MATH (HSL) ---
function rgbToHsl(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;

  if (max === min) {
    h = s = 0;
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h *= 60;
  }
  return [h, s, l];
}

function hexToRgb(hex) {
  const n = parseInt(hex.slice(1), 16);
  return [(n>>16)&255, (n>>8)&255, n&255];
}

function findBestLegoColor(r, g, b, useHslLogic) {
  let best = null;
  let minDiff = Infinity;
  
  const [srcH, srcS, srcL] = rgbToHsl(r,g,b);

  for (const lego of LEGO_PALETTE) {
    const [lr, lg, lb] = hexToRgb(lego.hex);
    
    let dist;
    if (useHslLogic) {
      const [lh, ls, ll] = rgbToHsl(lr, lg, lb);
      
      let hDiff = Math.abs(srcH - lh);
      if (hDiff > 180) hDiff = 360 - hDiff;
      
      let satPenalty = 0;
      if (srcS > 0.3 && ls < 0.2) satPenalty = 2.5;
      
      dist = (hDiff/180 * 2.5) + (Math.abs(srcS - ls) * 1.5) + (Math.abs(srcL - ll) * 1.0) + satPenalty;
      
      if (srcS < 0.15) {
         dist = Math.abs(srcL - ll) * 5 + (ls * 10);
      }

    } else {
      dist = Math.sqrt((r-lr)**2 + (g-lg)**2 + (b-lb)**2);
    }

    if (dist < minDiff) {
      minDiff = dist;
      best = lego;
    }
  }
  return best;
}

// --- IMAGE PROCESSING ---
function preprocessImage(ctx, w, h, saturation, contrast) {
  const idata = ctx.getImageData(0,0,w,h);
  const d = idata.data;
  
  const satMul = 1 + (saturation/50);
  const conMul = 1 + (contrast/100);
  const conOff = 128 * (1 - conMul);

  for(let i=0; i<d.length; i+=4) {
    let r=d[i], g=d[i+1], b=d[i+2];

    r = r * conMul + conOff;
    g = g * conMul + conOff;
    b = b * conMul + conOff;

    const gray = 0.2989*r + 0.5870*g + 0.1140*b;
    r = gray + (r - gray) * satMul;
    g = gray + (g - gray) * satMul;
    b = gray + (b - gray) * satMul;

    d[i] = Math.max(0,Math.min(255,r));
    d[i+1] = Math.max(0,Math.min(255,g));
    d[i+2] = Math.max(0,Math.min(255,b));
  }
  ctx.putImageData(idata, 0, 0);
  return idata;
}

function quantize(pixels, k) {
  const centers = [];
  const n = pixels.length/4;
  for(let i=0;i<k;i++) {
    const idx = Math.floor(Math.random()*n)*4;
    centers.push([pixels[idx], pixels[idx+1], pixels[idx+2]]);
  }
  
  const assign = new Int32Array(n);
  for(let iter=0; iter<10; iter++){
    for(let i=0; i<n; i++){
      const r=pixels[i*4], g=pixels[i*4+1], b=pixels[i*4+2];
      let bestD = Infinity, bestC = 0;
      for(let c=0; c<k; c++){
        const d = (r-centers[c][0])**2 + (g-centers[c][1])**2 + (b-centers[c][2])**2;
        if(d<bestD){ bestD=d; bestC=c; }
      }
      assign[i] = bestC;
    }
    const sums = Array.from({length:k}, ()=>([0,0,0,0]));
    for(let i=0; i<n; i++){
      const c = assign[i];
      sums[c][0]+=pixels[i*4]; sums[c][1]+=pixels[i*4+1]; sums[c][2]+=pixels[i*4+2]; sums[c][3]++;
    }
    for(let c=0; c<k; c++){
      if(sums[c][3]>0) {
        centers[c][0] = sums[c][0]/sums[c][3];
        centers[c][1] = sums[c][1]/sums[c][3];
        centers[c][2] = sums[c][2]/sums[c][3];
      }
    }
  }
  return {centers, assign};
}

// --- MAIN GENERATOR ---
async function generate() {
  if(!imgBitmap) { 
    alert("Please select an image first."); 
    return; 
  }
  
  const widthVal = parseInt(el('width').value);
  const colorCount = parseInt(el('colors').value);
  const brickSizes = el('bricksizes').value.split(',').map(Number).filter(n => !isNaN(n)).sort((a,b)=>b-a);
  const useHsl = el('hslMatch').checked;
  const avoidSeams = el('avoidSeams').checked;

  const ratio = imgBitmap.height / imgBitmap.width;
  const heightVal = Math.round(widthVal * ratio);
  
  const cvs = document.createElement('canvas');
  cvs.width = widthVal; cvs.height = heightVal;
  const ctx = cvs.getContext('2d');
  ctx.drawImage(imgBitmap, 0, 0, widthVal, heightVal);
  
  const idata = preprocessImage(ctx, widthVal, heightVal, 
                               parseInt(el('saturation').value), 
                               parseInt(el('contrast').value));

  const q = quantize(idata.data, colorCount);
  const legoMap = q.centers.map(c => findBestLegoColor(c[0], c[1], c[2], useHsl));
  
  const grid = [];
  for(let y=0; y<heightVal; y++) {
    const row = [];
    for(let x=0; x<widthVal; x++) {
      const idx = y*widthVal + x;
      row.push(legoMap[q.assign[idx]]);
    }
    grid.push(row);
  }

  const bricks = [];
  let prevSeams = new Set();
  
  for(let y=0; y<heightVal; y++) {
    let x = 0;
    const currentSeams = new Set();
    
    while(x < widthVal) {
      const color = grid[y][x];
      let bestSize = 1;
      
      for(const size of brickSizes) {
        if(x + size > widthVal) continue;
        
        let match = true;
        for(let k=0; k<size; k++) if(grid[y][x+k] !== color) match = false;
        if(!match) continue;

        const endX = x + size;
        if(avoidSeams && prevSeams.has(endX) && endX !== widthVal) continue;
        
        bestSize = size;
        break;
      }
      
      bricks.push({x, y, size: bestSize, color: color.hex, name: color.name});
      if(x + bestSize < widthVal) currentSeams.add(x + bestSize);
      x += bestSize;
    }
    prevSeams = avoidSeams ? currentSeams : new Set();
  }

  lastResult = { bricks, w:widthVal, h:heightVal };
  renderMosaic(bricks, widthVal, heightVal);
  renderBOM(bricks);
}

// --- RENDERING ---
function renderMosaic(bricks, w, h) {
  const cvs = el('render');
  const stud = 12;
  cvs.width = w * stud;
  cvs.height = h * stud;
  const ctx = cvs.getContext('2d');
  
  ctx.fillStyle = getVar('--bg-tertiary');
  ctx.fillRect(0,0,cvs.width,cvs.height);

  for(const b of bricks) {
    const x = b.x * stud;
    const y = b.y * stud;
    const bw = b.size * stud;
    
    ctx.fillStyle = b.color;
    ctx.fillRect(x+1, y+1, bw-2, stud-2);
    
    for(let i=0; i<b.size; i++) {
      const sx = x + i*stud + stud/2;
      const sy = y + stud/2;
      const r = stud * 0.35;
      
      ctx.beginPath();
      ctx.arc(sx+1, sy+1, r, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(sx, sy, r, 0, Math.PI*2);
      ctx.fillStyle = b.color;
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(sx - r*0.3, sy - r*0.3, r*0.25, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.4)';
      ctx.fill();
      
      ctx.strokeStyle = 'rgba(0,0,0,0.2)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.arc(sx, sy, r, 0, Math.PI*2); ctx.stroke();
    }
  }
}

function renderBOM(bricks) {
  const counts = {};
  bricks.forEach(b => {
    const k = b.name + '|' + b.size + '|' + b.color;
    if(!counts[k]) counts[k] = 0;
    counts[k]++;
  });
  
  const rows = Object.entries(counts).map(([k, count]) => {
    const [name, size, hex] = k.split('|');
    return {name, size:parseInt(size), hex, count};
  }).sort((a,b) => b.count - a.count);

  const tbody = el('bom-table').querySelector('tbody');
  tbody.innerHTML = '';
  
  const uniqueCols = new Set();
  
  rows.forEach(r => {
    uniqueCols.add(r.name);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="color-dot" style="background:${r.hex}"></span>${r.name}</td>
      <td>1 x ${r.size}</td>
      <td>${r.count}</td>
    `;
    tbody.appendChild(tr);
  });
  
  el('bom-card').style.display = 'block';
  el('total-bricks').textContent = bricks.length.toLocaleString();
  el('total-colors').textContent = uniqueCols.size;
  el('est-cost').textContent = '$' + (bricks.length * 0.10).toFixed(2);
  
  // Trigger animation
  el('bom-card').style.animation = 'none';
  setTimeout(() => {
    el('bom-card').style.animation = 'fadeInScale 0.6s ease forwards';
  }, 10);
}

// --- EXPORT ---
el('generate').addEventListener('click', generate);

el('downloadPNG').addEventListener('click', () => {
  if(!lastResult) return alert("Please generate a mosaic first.");
  const link = document.createElement('a');
  link.download = 'blockforge-mosaic.png';
  link.href = el('render').toDataURL();
  link.click();
});

el('downloadCSV').addEventListener('click', () => {
  if(!lastResult) return alert("Please generate a mosaic first.");
  let csv = "x,y,size,color_name,color_hex\n";
  lastResult.bricks.forEach(b => {
    csv += `${b.x},${b.y},${b.size},"${b.name}",${b.color}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url; 
  link.download = 'blockforge-bricks.csv';
  link.click();
  setTimeout(() => URL.revokeObjectURL(url), 100);
});

// Helper function to get CSS variable
function getVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name);
}

// Initialize animations
document.addEventListener('DOMContentLoaded', () => {
  const panels = document.querySelectorAll('.panel');
  panels.forEach(panel => {
    panel.style.opacity = '1';
    panel.style.transform = 'translateY(0)';
  });
});

</script>
</body>
</html>